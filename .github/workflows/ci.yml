name: Vue é¡¹ç›®è‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ECS

on:
  push:
    branches:
      - main  # å½“ main åˆ†æ”¯æœ‰æäº¤æ—¶è§¦å‘

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # ==================== ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç  ====================
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # ==================== ç¬¬äºŒæ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒ ====================
      - name: ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'

      # ==================== ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ä¾èµ– ====================
      - name: ğŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–
        run: yarn install

      # ==================== ç¬¬å››æ­¥ï¼šæ‰“åŒ… Vue é¡¹ç›® ====================
      - name: ğŸ—ï¸ æ‰“åŒ… Vue é¡¹ç›®
        run: yarn build

      # ==================== ç¬¬äº”æ­¥ï¼šå¤åˆ¶ public é™æ€èµ„æºåˆ° dist ====================
      - name: ğŸ“ å¤åˆ¶ public ç›®å½•é™æ€èµ„æºåˆ° dist
        run: |
          echo "å¤åˆ¶ public ç›®å½•ä¸‹çš„é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€PDFç­‰ï¼‰åˆ° dist..."
          # æ³¨æ„ï¼šæ’é™¤ index.htmlï¼Œé¿å…è¦†ç›– webpack æ‰“åŒ…ç”Ÿæˆçš„ index.html
          find public -type f ! -name 'index.html' -exec cp {} dist/ \;
          echo "dist ç›®å½•å†…å®¹ï¼š"
          ls -la dist/
          echo "éªŒè¯ index.html åŒ…å« bundle.js å¼•ç”¨ï¼š"
          grep -o 'bundle.js' dist/index.html || echo "è­¦å‘Šï¼šindex.html ä¸­æ²¡æœ‰æ‰¾åˆ° bundle.js å¼•ç”¨ï¼"

      # ==================== ç¬¬å…­æ­¥ï¼šè®¾ç½® Docker Buildx ====================
      - name: ğŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v2

      # ==================== ç¬¬ä¸ƒæ­¥ï¼šç™»å½•é˜¿é‡Œäº‘ ACR ====================
      - name: ğŸ³ ç™»å½•é˜¿é‡Œäº‘ ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # ==================== ç¬¬å…«æ­¥ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ ====================
      - name: ğŸ§± æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° ACR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ secrets.ACR_PROJECT }}:latest

      # ==================== ç¬¬ä¹æ­¥ï¼šéƒ¨ç½²åˆ° ECS ====================
      - name: ğŸš€ é€šè¿‡ SSH éƒ¨ç½²åˆ° ECS
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # è®¾ç½®é•œåƒåç§°
          ACR_REGISTRY="${{ secrets.ACR_REGISTRY }}"
          ACR_NAMESPACE="${{ secrets.ACR_NAMESPACE }}"
          ACR_PROJECT="${{ secrets.ACR_PROJECT }}"
          ACR_PASSWORD="${{ secrets.ACR_PASSWORD }}"
          ACR_USERNAME="${{ secrets.ACR_USERNAME }}"
          IMAGE_NAME="$ACR_REGISTRY/$ACR_NAMESPACE/$ACR_PROJECT:latest"

          ssh -o StrictHostKeyChecking=no root@${{ secrets.ECS_IP }} "set -e
            echo '========== 1. ç™»å½•é˜¿é‡Œäº‘ ACR =========='
            docker login -u $ACR_USERNAME -p $ACR_PASSWORD $ACR_REGISTRY

            echo '========== 2. æ‹‰å–æœ€æ–°é•œåƒ =========='
            docker pull $IMAGE_NAME
            
            echo '========== 3. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ =========='
            docker stop $ACR_PROJECT || true
            docker rm $ACR_PROJECT || true
            
            echo '========== 4. å¯åŠ¨æ–°å®¹å™¨ =========='
            docker run -d \
              --name $ACR_PROJECT \
              --restart always \
              -p 80:80 \
              $IMAGE_NAME

            echo '========== 5. æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ =========='
            docker ps | grep $ACR_PROJECT

            echo 'âœ… éƒ¨ç½²å®Œæˆï¼è®¿é—®åœ°å€ï¼šhttp://${{ secrets.ECS_IP }}'
          "